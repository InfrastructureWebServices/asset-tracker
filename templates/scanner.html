<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% include 'headers.html' %}
    <title>QR Scanner Demo</title>

    {% include 'floating-action-button.html' %}

    <link href="./public/css/scanner.css" rel="stylesheet">

</head>
<body>
    <div class="container" style="display: none;">
        <div class="section">
            <h1>Scan</h1>
        </div>
        <div class="section">

        </div>
        {#
        <div class="section">
            <div>
                <label>
                    Highlight Style
                    <select id="scan-region-highlight-style-select">
                        <option value="default-style">Default style</option>
                        <option value="example-style-1">Example custom style 1</option>
                        <option value="example-style-2">Example custom style 2</option>
                    </select>
                </label>
                <label>
                    <input id="show-scan-region" type="checkbox">
                    Show scan region canvas
                </label>
            </div>
        </div>
        #}
        <div class="section">
            <div>
                <select id="inversion-mode-select">
                    <option value="original">Scan original (dark QR code on bright background)</option>
                    <option value="invert">Scan with inverted colors (bright QR code on dark background)</option>
                    <option value="both">Scan both</option>
                </select>
                <br>
            </div>
            <b>Device has camera: </b>
            <span id="cam-has-camera"></span>
            <br>
            <div>
                <b>Preferred camera:</b>
                <select id="cam-list">
                    <option value="environment" selected="">Environment Facing (default)</option>
                    <option value="user">User Facing</option>
                </select>
            </div>
            <b>Camera has flash: </b>
            <span id="cam-has-flash"></span>
            <div>
                <button id="flash-toggle">ðŸ“¸ Flash: <span id="flash-state">off</span></button>
            </div>
            <br>
            <b>Detected QR code: </b>
            <span id="cam-qr-result">None</span>
            <br>
            <b>Last detected at: </b>
            <span id="cam-qr-result-timestamp"></span>
            <br>
            <ul id="scan-list">
            </ul>
            <br>
            <button id="start-button">Start</button>
            <button id="stop-button">Stop</button>
        </div>
        <div class="divider"></div>
        <div class="section">
            <h1>Scan from File:</h1>
            <input type="file" id="file-selector">
            <b>Detected QR code: </b>
            <span id="file-qr-result">None</span>
        </div>
    </div>
    <div id="video-container">
        <video id="qr-video"></video>
        <div style="position: absolute; display: none; pointer-events: none;" class="scan-region-highlight"></div>
    </div>
    <div class="fixed-action-btn click-to-toggle">
        <a class="btn-floating btn-large">
            <span id="scan-count" class="badge"></span>
        </a>
        <ul>
            <li id="start-scanner-button"><a class="btn-floating blue" onclick="startScanner();"><i class="material-icons">photo_camera</i></a></li>
            <li id="send-to-picklist-button" style="display: none;"><a class="btn-floating blue"><i class="material-icons">local_shipping</i></a></li>
            <li id="flip-camera-button" style="display: none;"><a class="btn-floating blue" onclick="toggleCameras();"><i class="material-icons">flip_camera_ios</i></a></li>
            <li id="stop-scanner-button" style="display: none;"><a class="btn-floating green" onclick="stopScanner();"><i class="material-icons">check</i></a></li>
        </ul>
    </div>
    {% include 'pixabay.html' %}

    <script type="module">     

        import QrScanner from "./public/js/qr-scanner.min.js";

        const video = document.getElementById('qr-video');
        const videoContainer = document.getElementById('video-container');
        const camHasCamera = document.getElementById('cam-has-camera');
        const camList = document.getElementById('cam-list');
        const camHasFlash = document.getElementById('cam-has-flash');
        const flashToggle = document.getElementById('flash-toggle');
        const flashState = document.getElementById('flash-state');
        const camQrResult = document.getElementById('cam-qr-result');
        const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
        const fileSelector = document.getElementById('file-selector');
        const fileQrResult = document.getElementById('file-qr-result');
        
        const scanList = document.getElementById('scan-list');
        let unique_scanned_items = [];

        function setResult(label, result) {
            console.log(result.data);
            label.textContent = result.data;
            if (unique_scanned_items.indexOf(result.data) < 0) { 
                camera_shutter_sound.play();
                unique_scanned_items.push(result.data);
                let new_item = document.createElement('li');
                let anchor = document.createElement('a');
                anchor.setAttribute('href', result.data);
                anchor.setAttribute('target', "_blank");
                anchor.textContent = result.data;
                new_item.appendChild(anchor);
                scanList.appendChild(new_item);
                document.getElementById('scan-count').textContent = String(unique_scanned_items.length);
            }
            document.getElementById('send-to-picklist-button').style.display = 'inline-block';

            camQrResultTimestamp.textContent = new Date().toString();
            label.style.color = 'teal';
            clearTimeout(label.highlightTimeout);
            label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
        }

        // ####### Web Cam Scanning #######

        const scanner = new QrScanner(video, result => setResult(camQrResult, result), {
            onDecodeError: error => {
                // camQrResult.textContent = error;
                // camQrResult.style.color = 'inherit';
            },
            highlightScanRegion: true,
            highlightCodeOutline: true,
        });

        const updateFlashAvailability = () => {
            scanner.hasFlash().then(hasFlash => {
                camHasFlash.textContent = hasFlash;
                flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
            });
        };

        window.active_camera = 0;

        const toggleCameras = () => {
            active_camera += 1
            active_camera = (active_camera % cameras.length)
            scanner.setCamera(cameras[active_camera].id).then(updateFlashAvailability);
        }
        window.toggleCameras = toggleCameras;

        const startScanner = () => { 
            scanner.start().then(() => {
                updateFlashAvailability();
                // List cameras after the scanner started to avoid listCamera's stream and the scanner's stream being requested
                // at the same time which can result in listCamera's unconstrained stream also being offered to the scanner.
                // Note that we can also start the scanner after listCameras, we just have it this way around in the demo to
                // start the scanner earlier.
                QrScanner.listCameras(true).then(cameras => {
                    window.cameras = cameras;
                    if (cameras.length > 1) {
                        document.getElementById('flip-camera-button').style.display = 'inline-block';
                    }
                });
                document.getElementById('start-scanner-button').style.display = 'none';
                document.getElementById('stop-scanner-button').style.display = 'inline-block';
                // fixed_action_button.close();
            });
        }
        window.startScanner = startScanner;

        const stopScanner = () => {
            scanner.stop();
            document.getElementById('stop-scanner-button').style.display = 'none';
            document.getElementById('send-to-picklist-button').style.display = 'none';
            document.getElementById('flip-camera-button').style.display = 'none';
            document.getElementById('start-scanner-button').style.display = 'inline-block';
            fixed_action_button.close();
        }
        window.stopScanner = stopScanner;

        QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);

        // for debugging
        window.scanner = scanner;



        {#
        document.getElementById('scan-region-highlight-style-select').addEventListener('change', (e) => {
            videoContainer.className = e.target.value;
            scanner._updateOverlay(); // reposition the highlight because style 2 sets position: relative
        });

        document.getElementById('show-scan-region').addEventListener('change', (e) => {
            const input = e.target;
            const label = input.parentNode;
            label.parentNode.insertBefore(scanner.$canvas, label.nextSibling);
            scanner.$canvas.style.display = input.checked ? 'block' : 'none';
        });
        #}

        document.getElementById('inversion-mode-select').addEventListener('change', event => {
            scanner.setInversionMode(event.target.value);
        });

        camList.addEventListener('change', event => {
            scanner.setCamera(event.target.value).then(updateFlashAvailability);
        });

        flashToggle.addEventListener('click', () => {
            scanner.toggleFlash().then(() => flashState.textContent = scanner.isFlashOn() ? 'on' : 'off');
        });

        document.getElementById('start-button').addEventListener('click', () => {
            startScanner();
        });

        document.getElementById('stop-button').addEventListener('click', () => {
            scanner.stop();
        });

        {#
        // ####### File Scanning #######

        fileSelector.addEventListener('change', event => {
            const file = fileSelector.files[0];
            if (!file) {
                return;
            }
            QrScanner.scanImage(file, { returnDetailedScanResult: true })
                .then(result => setResult(fileQrResult, result))
                .catch(e => setResult(fileQrResult, { data: e || 'No QR code found.' }));
        });
        #}
    </script>
</body>
</html>